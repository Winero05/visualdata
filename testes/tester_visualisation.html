<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Test API: Visualisations Image & Tabulaire</title>
    <style>
        body { font-family: sans-serif; margin: 40px; background-color: #f4f7f6; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        /* Onglets */
        .tabs { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 20px; }
        .tab-button { background-color: #eee; border: none; padding: 10px 20px; cursor: pointer; font-size: 16px; border-top-left-radius: 5px; border-top-right-radius: 5px; margin-right: 5px; }
        .tab-button.active { background-color: #3498db; color: white; }
        .tab-content { display: none; padding-top: 20px; }
        .tab-content.active { display: block; }

        /* Formulaire & R√©sultats */
        label { display: block; margin-top: 15px; font-weight: bold; }
        input[type="file"], select, input[type="text"] { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #2ecc71; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px; font-size: 16px; }
        button:hover { background-color: #27ae60; }
        #results { margin-top: 30px; padding: 15px; border: 1px dashed #27ae60; border-radius: 4px; background-color: #ecf0f1; text-align: center; }
        #plot-image { max-width: 100%; height: auto; border: 1px solid #ddd; margin-top: 15px; display: none; }
        .alert { padding: 10px; border-radius: 4px; margin-top: 10px; font-weight: bold; }
        .alert.error { background-color: #fdd; color: #c00; border-color: #c00; }
        .alert.success { background-color: #dfd; color: #27ae60; border-color: #27ae60; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñºÔ∏è Testez les Endpoints de Visualisation</h1>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('tabulaire', this)">Visualisation Tabulaire</button>
            <button class="tab-button" onclick="showTab('image', this)">Visualisation Image</button>
        </div>

        <div id="error-message" class="alert error" style="display: none;"></div>
        <div id="success-message" class="alert success" style="display: none;"></div>

        <div id="tabulaire" class="tab-content active">
            <h2>üìà Visualisation Tabulaire (`/visualiser/tabulaire/`)</h2>
            <form id="tabular-form" data-endpoint="visualiser/tabulaire/">
                
                <label for="file_tabular">Fichier de Donn√©es (CSV/Excel)</label>
                <input type="file" id="file_tabular" name="file" accept=".csv, .xlsx, .xls" required>
                
                <label for="type_graphique">Type de Graphique</label>
                <select id="type_graphique" name="type_graphique" required>
                    <option value="distributions">Distributions (Histogrammes)</option>
                    <option value="correlations">Corr√©lations (Heatmap)</option>
                </select>

                <button type="submit">G√©n√©rer la Visualisation Tabulaire</button>
            </form>
        </div>

        <div id="image" class="tab-content">
            <h2>üì∑ Visualisation Image (`/visualiser/image/`)</h2>
            <form id="image-form" data-endpoint="visualiser/image/">
                
                <label for="file_image">Fichier Image (JPG, PNG)</label>
                <input type="file" id="file_image" name="file" accept="image/png, image/jpeg" required>
                
                <label for="type_visualisation">Type de Visualisation</label>
                <select id="type_visualisation" name="type_visualisation" required>
                    <option value="image">Afficher l'Image Originale</option>
                    <option value="histogramme">Histogramme d'Intensit√©</option>
                </select>

                <input type="hidden" name="chemin_fichier" value=""> 

                <button type="submit">G√©n√©rer la Visualisation Image</button>
            </form>
        </div>


        <div id="results">
            <h2>R√©sultat de l'API</h2>
            <p id="message-api">En attente de l'ex√©cution...</p>
            <img id="plot-image" alt="Visualisation">
        </div>

    </div>

    <script>
        // L'URL de base de votre API
        const API_BASE_URL = 'http://127.0.0.1:8000/';

        function showTab(tabId, button) {
            // Cacher tous les contenus
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            // Montrer le contenu cible
            document.getElementById(tabId).classList.add('active');
            
            // Mettre √† jour les boutons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
        }

        // Fonction g√©n√©rique pour l'envoi de formulaire
        async function submitForm(event) {
            event.preventDefault();
            
            const form = event.target;
            const endpoint = form.getAttribute('data-endpoint');
            const url = API_BASE_URL + endpoint;

            const statusMessage = document.getElementById('message-api');
            const plotImage = document.getElementById('plot-image');
            const errorDiv = document.getElementById('error-message');
            const successDiv = document.getElementById('success-message');

            statusMessage.textContent = 'Envoi de la requ√™te...';
            plotImage.style.display = 'none';
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            // Utiliser FormData pour g√©rer √† la fois les fichiers et les champs de formulaire
            const formData = new FormData(form);

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    // Succ√®s
                    const title = data.title || 'Visualisation G√©n√©r√©e';
                    statusMessage.textContent = `Succ√®s ! Type de graphique: ${data.graph_type}. Titre: ${title}`;
                    successDiv.textContent = `Visualisation g√©n√©r√©e avec succ√®s !`;
                    successDiv.style.display = 'block';
                    
                    // Affichage de l'image
                    plotImage.src = `data:image/png;base64,${data.image_data}`;
                    plotImage.alt = title;
                    plotImage.style.display = 'block';

                } else {
                    // Erreur API (4xx ou 5xx)
                    statusMessage.textContent = `√âchec de la requ√™te (Code ${response.status}): ${data.detail || 'Erreur inconnue'}`;
                    errorDiv.textContent = data.detail ? (typeof data.detail === 'string' ? data.detail : JSON.stringify(data.detail)) : 'Erreur inconnue de l\'API.';
                    errorDiv.style.display = 'block';
                }

            } catch (error) {
                // Erreur r√©seau ou JavaScript
                statusMessage.textContent = `Erreur r√©seau: Impossible de connecter √† l'API.`;
                errorDiv.textContent = `Erreur de connexion: Assurez-vous que l'API est lanc√©e sur ${API_BASE_URL}`;
                errorDiv.style.display = 'block';
            }
        }

        // Attacher les √©couteurs d'√©v√©nements
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('tabular-form').addEventListener('submit', submitForm);
            document.getElementById('image-form').addEventListener('submit', submitForm);
        });
    </script>
</body>
</html>